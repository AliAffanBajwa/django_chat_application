{% extends "authApp/base.html" %}

{% block title %}Home{% endblock %}

{% block content %}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark w-100">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Real-time Chat Application</a>

        <div class="d-flex align-items-center justify-content-center mx-auto">
            {% if user.is_authenticated %}
                <span class="navbar-text me-3 text-light">
                    <strong>{{ user.username }}</strong> Logged in &nbsp;&nbsp;
                </span>
                <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
            {% endif %}
        </div>

        <div class="dropdown ms-auto">
            <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="chatDropdownMenu"
                data-bs-toggle="dropdown"
                aria-expanded="false"
            >
                Chat Options
            </button>
            <ul class="dropdown-menu" aria-labelledby="chatDropdownMenu">
                <li><a class="dropdown-item" href="{% url 'home' %}">Public Chat</a></li>
                <li><a class="dropdown-item" href="{% url 'new-groupchat' %}">Group Chat</a></li>
                {% for chatroom in user.chat_groups.all %}
                {% if chatroom.groupchat_name %}
                <li>
                    <a class="dropdown-item" href="{% url 'chatroom' chatroom.group_name %}">
                        {{ chatroom.groupchat_name }}
                    </a>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
</nav>

<div class="container my-5">
    <div id="chat_window" class="card bg-dark text-light shadow-lg rounded-4 overflow-hidden">
       
        <div class="card-header text-center bg-dark text-success py-3 border-0">
            {% if chat_group.groupchat_name %}
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">{{ chat_group.groupchat_name }}</h5>
                {% if user == chat_group.admin %}
                <a href="{% url 'edit-chatroom' chat_group.group_name %}" class="text-decoration-none">
                    <div class="p-2 bg-light rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm" style="cursor: pointer; width: 40px; height: 40px;">
                        <svg class="fill-secondary" width="16" height="16">
                            <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"></path>
                        </svg>
                    </div>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        

        <div class="card-body overflow-auto" style="height: 45rem; display: flex; flex-direction: column; border-top: 1px solid #6c757d;">
            {% if chat_group.groupchat_name %}
            <div class="bg-dark text-center mb-3 py-2 border-bottom border-secondary">
                <ul class="list-inline mb-0">
                    {% for member in chat_group.members.all %}
                    <li class="list-inline-item text-light text-truncate" style="max-width: 10rem;">
                        <small><strong>{{ member.username }}</strong></small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div id="chat_container" class="overflow-auto flex-grow-1 d-flex flex-column-reverse">
                <ul id="chat_messages" class="list-unstyled mb-0">
                    {% for message in chat_messages reversed %}
                        {% include 'rtChat/chat_message.html' %}
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card-footer bg-dark border-top border-secondary py-3">
            <form id="chat_message_form" class="d-flex flex-column gap-3" method="POST">
                {% csrf_token %}
                <div class="input-group">
                    {{ form.body }}
                    <button type="submit" class="btn btn-success">Send</button>
                </div>
            </form>
        
            <form id="chat_file_form" enctype="multipart/form-data" class="d-flex align-items-center mt-3" method="POST">
                {% csrf_token %}
                <input type="file" name="file" id="id_file" class="form-control text-secondary">
                <button type="submit" class="btn btn-primary text-nowrap ms-2">Upload</button>
            </form>
        </div>
        
    </div>

    <div class="text-end mt-3">
        {% if chat_group.members.exists %}
        <a href="{% url 'chatroom-leave' chat_group.group_name %}" class="btn btn-outline-danger btn-sm">
            Leave Chat
        </a>
        {% endif %}
    </div>
</div>


{% endblock %}

{% block javascript %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const chatContainer = document.getElementById("chat_container");
    const chatMessages = document.getElementById("chat_messages");

    // Scroll chat container to the bottom
    function scrollChatToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // WebSocket connection
    const socket = new WebSocket(`ws://localhost:8000/ws/chatroom/{{ chatroom_name }}`);
    const currentUser = "{{ user.username }}";

    // WebSocket events
    socket.addEventListener("open", () => console.log("WebSocket connection established"));
    socket.addEventListener("error", (error) => console.error("WebSocket error:", error));
    socket.addEventListener("message", (event) => handleIncomingMessage(event));

    // Function to handle incoming WebSocket messages
    async function handleIncomingMessage(event) {
        try {
            const data = JSON.parse(event.data);
            const isCurrentUser = data.author === currentUser;

            // Skip rendering duplicate file upload for the sender
            if (isCurrentUser && data.source === "file_upload") return;

            const messageElement = document.createElement("li");
            messageElement.classList.add("d-flex", isCurrentUser ? "justify-content-end" : "justify-content-start", "mb-3");

            if (data.body) {
                // Handle text message
                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'bg-success text-light' : 'bg-light text-dark'} rounded-3 p-3 shadow-sm chat-message">
                        ${data.body}
                    </div>
                    ${!isCurrentUser ? `<div class="text-muted small mt-1">${data.author}</div>` : ""}
                `;
            } else if (data.file_url) {
                // Ensure no duplicate rendering of the same file
                const existingFile = document.querySelector(`a[href="${data.file_url}"]`);
                if (existingFile) return; // File already rendered

                // Handle file message with PDF preview
                const isPDF = data.file_url.endsWith(".pdf");
                const fileName = data.file_name || "Download File";

                messageElement.innerHTML = `
                    <div class="${isCurrentUser ? 'bg-success text-light' : 'bg-light text-dark'} rounded-3 p-3 shadow-sm chat-message">
                        ${isPDF ? '<canvas class="pdf-preview" style="max-width: 18rem; min-width: 2rem;" data-rendering="false"></canvas>' : ""}
                        <a href="${data.file_url}" target="_blank" download>${fileName}</a>
                    </div>
                    ${!isCurrentUser ? `<div class="text-muted small mt-1">${data.author}</div>` : ""}
                `;
            }

            chatMessages.appendChild(messageElement);
            scrollChatToBottom();

            // Initialize PDF preview if needed
            if (data.file_url && data.file_url.endsWith(".pdf")) {
                const canvas = messageElement.querySelector(".pdf-preview");
                initializePDFPreview(canvas);
            }
        } catch (error) {
            console.error("Error processing incoming WebSocket message:", error);
        }
    }

    // Sending text messages
    document.getElementById("chat_message_form").addEventListener("submit", (event) => {
        event.preventDefault();

        const input = event.target.querySelector("[name='body']");
        const messageContent = input.value.trim();

        if (!messageContent) return;

        if (socket.readyState === WebSocket.OPEN) {
            const messageData = { body: messageContent, author: currentUser };
            socket.send(JSON.stringify(messageData));
            input.value = "";
        } else {
            console.error("WebSocket is not open");
        }
    });

   // File upload functionality
    document.getElementById("chat_file_form").addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(event.target);
        const csrfToken = document.querySelector("input[name='csrfmiddlewaretoken']").value;

        try {
            const response = await fetch("{% url 'chat-file-upload' chatroom_name %}", {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": csrfToken },
            });

            if (response.ok) {
                const data = await response.json();
                const isPDF = data.file_url.endsWith(".pdf");
                const fileName = data.file_name || "Download File";

                // Check if the file is already rendered
                const existingFile = document.querySelector(`a[href="${data.file_url}"]`);
                if (existingFile) return;

                // Render file preview for the sender
                const messageElement = document.createElement("li");
                messageElement.classList.add("d-flex", "justify-content-end", "mb-3");

                messageElement.innerHTML = `
                    <div class="bg-success text-light rounded-3 p-3 shadow-sm chat-message">
                        ${isPDF ? '<canvas class="pdf-preview" style="max-width: 18rem; min-width: 2rem;" data-rendering="false"></canvas>' : ""}
                        <a href="${data.file_url}" target="_blank" download>${fileName}</a>
                    </div>
                `;

                chatMessages.appendChild(messageElement);
                scrollChatToBottom();

                // Initialize PDF preview for the sender
                if (isPDF) {
                    const canvas = messageElement.querySelector(".pdf-preview");
                    initializePDFPreview(canvas);
                }

                // Send file URL via WebSocket with a "file_upload" source
                if (socket.readyState === WebSocket.OPEN) {
                    const fileMessage = {
                        file_url: data.file_url,
                        file_name: data.file_name,
                        author: currentUser,
                        source: "file_upload", // Identify as sender
                    };
                    socket.send(JSON.stringify(fileMessage));
                }
            } else {
                console.error("File upload failed:", response.statusText);
            }
        } catch (error) {
            console.error("File upload error:", error);
        }
    });


    // PDF preview initialization
    function initializePDFPreview(canvas) {
        if (!canvas) return;

        if (canvas.dataset.rendering === "true") return;

        canvas.dataset.rendering = "true";

        const pdfjsLib = window["pdfjs-dist/build/pdf"];
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
        const fileUrl = canvas.nextElementSibling?.href;

        if (fileUrl && fileUrl.endsWith(".pdf")) {
            const ctx = canvas.getContext("2d");

            pdfjsLib.getDocument(fileUrl).promise
                .then((pdfDoc) => pdfDoc.getPage(1))
                .then((page) => {
                    const viewport = page.getViewport({ scale: 1 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    return page.render({
                        canvasContext: ctx,
                        viewport: viewport,
                    }).promise;
                })
                .catch((err) => console.error("Error rendering PDF preview:", err))
                .finally(() => {
                    canvas.dataset.rendering = "false";
                });
        } else {
            console.error("Invalid PDF file URL:", fileUrl);
            canvas.dataset.rendering = "false";
        }
    }

    // Initial scroll to bottom on page load
    scrollChatToBottom();
});

</script>
    
{% endblock %} 